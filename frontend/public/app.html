<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Computer Use Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .vnc-container {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 480px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="mb-8">
            <h1 class="text-4xl font-bold mb-2">AWS Computer Use Demo</h1>
            <p class="text-gray-600">AI-powered desktop automation using Amazon Bedrock and Claude</p>
        </header>

        <div id="app">
            <!-- Session Creation -->
            <div id="session-create" class="grid gap-6 md:grid-cols-2">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-semibold mb-2">Create New Session</h2>
                    <p class="text-gray-600 mb-4">Start a new desktop session with AI control</p>
                    <div class="space-y-4">
                        <div>
                            <label for="userId" class="block text-sm font-medium mb-2">User ID (optional)</label>
                            <input type="text" id="userId" class="w-full px-3 py-2 border rounded-md" placeholder="Enter your user ID or leave blank">
                        </div>
                        <button onclick="createSession()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">
                            <i class="fas fa-desktop mr-2"></i>Create Session
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-semibold mb-2">Your Sessions</h2>
                    <p class="text-gray-600 mb-4">View and manage your active sessions</p>
                    <div id="session-list" class="space-y-2">
                        <p class="text-gray-500">No active sessions</p>
                    </div>
                </div>
            </div>

            <!-- Active Session -->
            <div id="session-active" style="display: none;" class="space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-semibold">Active Session</h2>
                            <p class="text-gray-600">Session ID: <span id="session-id"></span></p>
                        </div>
                        <button onclick="terminateSession()" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 transition">
                            Terminate Session
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white rounded-lg shadow">
                    <div class="border-b">
                        <nav class="flex">
                            <button onclick="switchTab('desktop')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent" data-tab="desktop">
                                <i class="fas fa-desktop mr-2"></i>Desktop
                            </button>
                            <button onclick="switchTab('chat')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent" data-tab="chat">
                                <i class="fas fa-comments mr-2"></i>AI Assistant
                            </button>
                            <button onclick="switchTab('settings')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent" data-tab="settings">
                                <i class="fas fa-cog mr-2"></i>Settings
                            </button>
                        </nav>
                    </div>

                    <!-- Desktop Tab -->
                    <div id="desktop-tab" class="tab-content active p-6">
                        <div class="vnc-container rounded">
                            <div id="vnc-loading" class="text-white text-center">
                                <div class="spinner mx-auto mb-4"></div>
                                <p>Connecting to desktop...</p>
                            </div>
                            <iframe id="vnc-frame" style="display: none;" width="100%" height="600" frameborder="0"></iframe>
                        </div>
                    </div>

                    <!-- Chat Tab -->
                    <div id="chat-tab" class="tab-content p-6">
                        <div class="border rounded-lg h-96 flex flex-col">
                            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto">
                                <p class="text-gray-500 text-center">No messages yet. Start a conversation!</p>
                            </div>
                            <div class="border-t p-4">
                                <div class="flex space-x-2">
                                    <input type="text" id="chat-input" class="flex-1 px-3 py-2 border rounded" placeholder="Type your message...">
                                    <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="settings-tab" class="tab-content p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">VNC URL</label>
                                <input type="text" id="vnc-url" class="w-full px-3 py-2 border rounded bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">WebSocket URL</label>
                                <input type="text" id="ws-url" class="w-full px-3 py-2 border rounded bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Status</label>
                                <input type="text" id="session-status" class="w-full px-3 py-2 border rounded bg-gray-50" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_ENDPOINT = 'https://p0lkqwkiy4.execute-api.us-west-2.amazonaws.com/dev';
        const WS_ENDPOINT = 'wss://uaakatj7z0.execute-api.us-west-2.amazonaws.com/dev';
        const ALB_ENDPOINT = 'http://computer-use-dev-797992487.us-west-2.elb.amazonaws.com';

        let currentSession = null;
        let ws = null;

        // Session Management
        async function createSession() {
            const userId = document.getElementById('userId').value || 'anonymous';
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            
            try {
                const response = await fetch(`${API_ENDPOINT}/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create session');
                }
                
                const session = await response.json();
                currentSession = session;
                showActiveSession(session);
                connectWebSocket(session.session_id);
                
                // Wait a bit for the container to start before loading VNC
                setTimeout(() => loadVNC(session.session_id), 5000);
            } catch (error) {
                console.error('Session creation error:', error);
                alert('Error creating session: ' + error.message);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-desktop mr-2"></i>Create Session';
            }
        }

        async function terminateSession() {
            if (!currentSession) return;
            
            try {
                await fetch(`${API_ENDPOINT}/sessions/${currentSession.session_id}`, {
                    method: 'DELETE'
                });
                
                currentSession = null;
                if (ws) ws.close();
                showSessionCreate();
            } catch (error) {
                alert('Error terminating session: ' + error.message);
            }
        }

        async function loadSessions(userId) {
            try {
                const response = await fetch(`${API_ENDPOINT}/sessions?user_id=${userId || 'anonymous'}`);
                const sessions = await response.json();
                
                const listEl = document.getElementById('session-list');
                if (sessions.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">No active sessions</p>';
                } else {
                    listEl.innerHTML = sessions.map(s => `
                        <div class="border rounded p-3 cursor-pointer hover:bg-gray-50" onclick="resumeSession('${s.session_id}')">
                            <p class="font-medium">Session ${s.session_id.slice(0, 8)}...</p>
                            <p class="text-sm text-gray-600">Status: ${s.status}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        async function resumeSession(sessionId) {
            try {
                const response = await fetch(`${API_ENDPOINT}/sessions/${sessionId}`);
                if (!response.ok) throw new Error('Session not found');
                
                const session = await response.json();
                currentSession = session;
                showActiveSession(session);
                connectWebSocket(session.session_id);
                loadVNC(session.session_id);
            } catch (error) {
                alert('Error resuming session: ' + error.message);
            }
        }

        // UI Management
        function showActiveSession(session) {
            document.getElementById('session-create').style.display = 'none';
            document.getElementById('session-active').style.display = 'block';
            document.getElementById('session-id').textContent = session.session_id;
            document.getElementById('vnc-url').value = session.vnc_url || 'Initializing...';
            document.getElementById('ws-url').value = session.websocket_url || `${WS_ENDPOINT}?session_id=${session.session_id}`;
            document.getElementById('session-status').value = session.status || 'starting';
            
            // Fetch session details to get container IP
            fetchSessionDetails(session.session_id);
        }
        
        async function fetchSessionDetails(sessionId) {
            try {
                const response = await fetch(`${API_ENDPOINT}/sessions/${sessionId}`);
                if (response.ok) {
                    const details = await response.json();
                    if (details.private_ip) {
                        document.getElementById('vnc-url').value = `vnc://${details.private_ip}:5900`;
                    }
                    document.getElementById('session-status').value = details.status || 'unknown';
                }
            } catch (error) {
                console.error('Error fetching session details:', error);
            }
        }

        function showSessionCreate() {
            document.getElementById('session-create').style.display = 'grid';
            document.getElementById('session-active').style.display = 'none';
            loadSessions(document.getElementById('userId').value);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-700');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.remove('border-transparent', 'text-gray-700');
            activeBtn.classList.add('border-blue-600', 'text-blue-600');
        }

        // VNC Connection
        function loadVNC(sessionId) {
            const frame = document.getElementById('vnc-frame');
            const loading = document.getElementById('vnc-loading');
            
            // Load VNC viewer page
            frame.src = `${ALB_ENDPOINT}/vnc/${sessionId}`;
            frame.onload = () => {
                loading.style.display = 'none';
                frame.style.display = 'block';
            };
            frame.onerror = () => {
                loading.innerHTML = `
                    <div class="text-white text-center">
                        <div class="mb-4">
                            <i class="fas fa-exclamation-triangle fa-3x text-yellow-500"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">Connection Error</h3>
                        <p class="mb-4">Unable to connect to desktop session</p>
                        <button onclick="loadVNC('${sessionId}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Retry Connection
                        </button>
                    </div>
                `;
            };
        }

        // WebSocket Connection
        function connectWebSocket(sessionId) {
            ws = new WebSocket(`${WS_ENDPOINT}?session_id=${sessionId}`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                ws.send(JSON.stringify({ action: 'connect', session_id: sessionId }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'message') {
                    addChatMessage(data.message, data.sender);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Chat Functions
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            ws.send(JSON.stringify({
                action: 'message',
                message: message
            }));
            
            addChatMessage(message, 'user');
            input.value = '';
        }

        function addChatMessage(message, sender) {
            const messagesEl = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `mb-4 ${sender === 'user' ? 'text-right' : 'text-left'}`;
            messageEl.innerHTML = `
                <div class="inline-block max-w-md px-4 py-2 rounded-lg ${
                    sender === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-200'
                }">
                    ${message}
                </div>
            `;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Initialize
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        loadSessions();
    </script>
</body>
</html>